from typing import TYPE_CHECKING, List, Optional

from sqlalchemy import ForeignKey, Integer, String
from sqlalchemy.orm import Mapped, mapped_column, relationship

from models.base import Base

if TYPE_CHECKING:
    from models.metro import Line, Station
    from models.money import ExchangeRequest, Wallet
    from models.users import Camper, Counselor, Methodist


class AgeGroup(Base):
    __tablename__ = "age_groups"

    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(100), nullable=False)
    squads: Mapped[List["Squad"]] = relationship(back_populates="age_group")
    methodist: Mapped["Methodist"] = relationship(back_populates="age_group")

    def __init__(self, name: str):
        self.name = name


class Squad(Base):
    __tablename__ = "squads"

    id: Mapped[int] = mapped_column(primary_key=True)
    number: Mapped[int] = mapped_column(Integer, nullable=False)
    name: Mapped[str] = mapped_column(String(100))
    age_group_id: Mapped[int] = mapped_column(
        ForeignKey("age_groups.id"), nullable=False
    )
    age_group: Mapped["AgeGroup"] = relationship(back_populates="squads")
    stations: Mapped[List["Station"]] = relationship(back_populates="owner")
    wallet: Mapped["Wallet"] = relationship(back_populates="squad")
    counselors: Mapped[List["Counselor"]] = relationship(back_populates="squad")
    campers: Mapped[List["Camper"]] = relationship(back_populates="squad")
    incoming_exchange_requests: Mapped[List["ExchangeRequest"]] = relationship(
        back_populates="another_squad", foreign_keys="ExchangeRequest.another_squad_id"
    )
    outgoing_exchange_requests: Mapped[List["ExchangeRequest"]] = relationship(
        back_populates="origin_squad", foreign_keys="ExchangeRequest.origin_squad_id"
    )

    def __init__(self, name: str, age_group: "AgeGroup"):
        self.name = name
        self.age_group = age_group

    def get_all_lines(self) -> list["Line"]:
        lines = []
        for station in self.stations:
            if station.line and station.line not in lines:
                lines.append(station.line)
        return lines

    def get_full_balance(self):
        sum_of_stations = 0
        for line in self.get_all_lines():
            sum_of_stations += line.get_sum_of_stations_by_squad(self)
        return sum_of_stations + self.wallet.current_balance
