<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Профиль</title>
    <script>
      function chngOwner() {
        event.preventDefault()
      
        var messageField = document.getElementById('ownerField')
        var form = new FormData(document.forms.changeOwner)
        var xhr = new XMLHttpRequest()
        xhr.open('POST', '/admin/change-station-owner')
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            var resp = JSON.parse(xhr.responseText)
            if (xhr.status == 201) {
              messageField.style.color = 'green'
              messageField.innerHTML = resp.message
            } else if (xhr.status == 401 || xhr.status == 400) {
              messageField.style.display = 'block'
              messageField.style.color = 'red'
              messageField.innerHTML = resp.message
            } else {
              messageField.style.display = 'block'
              messageField.style.color = 'red'
              messageField.innerHTML = 'Неизвестная ошибка, обратитесь к администратору'
            }
          }
        }
        xhr.send(form)
      }
      
      function adBalance() {
        event.preventDefault()
      
        var messageField = document.getElementById('addField')
        var form = new FormData(document.forms.addBalance)
        var xhr = new XMLHttpRequest()
        xhr.open('POST', '/admin/add-balance')
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            var resp = JSON.parse(xhr.responseText)
            if (xhr.status == 201) {
              messageField.style.display = 'block'
              messageField.style.color = 'green'
              messageField.innerHTML = resp.message
            } else if (xhr.status == 401 || xhr.status == 400) {
              messageField.style.display = 'block'
              messageField.style.color = 'red'
              messageField.innerHTML = resp.message
            } else {
              messageField.style.display = 'block'
              messageField.style.color = 'red'
              messageField.innerHTML = 'Неизвестная ошибка, обратитесь к администратору'
            }
          }
        }
        xhr.send(form)
      }
    </script>
  </head>

  <body>
    <h1>Админ {{ user.username }}</h1>
    <br />

    <h2>Покупка станции:</h2>
    <form name="changeOwner" onsubmit="chngOwner()">
      <label for="chngStation">Станция:</label>
      <select name="station_id" id="chngStation">
        {% for station in stations %}
          <option value="{{ station.id }}">{{ station.line.number }} {{ station.name }}</option>
        {% endfor %}
      </select>
      <label for="chngSquad">Новый владелец:</label>
      <select name="squad_id" id="chngSquad">
        <option value="-1">Нет владельца</option>
        {% for squad in squads %}
          <option value="{{ squad.id }}">{{ squad.name }} отряд</option>
        {% endfor %}
      </select>
      <input type="submit" value="Изменить" />
    </form>

    <div id="ownerField"></div>
    <br />

    <h2>Обновление балансов:</h2>
    <form name="addBalance" onsubmit="adBalance()">
      <label for="addSquad">Номер отряда:</label>
      <select name="squad_id" id="addSquad" required>
        <option hidden disabled selected value>выберите отряд</option>
        {% for squad in squads %}
          <option value="{{ squad.id }}">{{ squad.name }}</option>
        {% endfor %}
      </select>

      <fieldset>
        <legend>Действие (списать или прибавить):</legend>
        <label for="add_radio">Начислить</label>
        <input type="radio" name="type" id="add_radio" value="deposit" checked />
        <label for="sub_radio">Списать</label>
        <input type="radio" name="type" id="sub_radio" value="withdraw" />
      </fieldset>

      <label for="addAmount">Сумма:</label>
      <input type="number" name="amount" id="addAmount" required min="0" />
      <label for="addReason">Основание:</label>
      <input type="text" name="reason" id="addReason" />
      <input type="submit" value="Применить" />
    </form>

    <div id="addField"></div>

    <a href="/logout"><button>Выйти</button></a>
  </body>
</html>
